# CMDB èµ„äº§ç®¡ç†ç³»ç»Ÿ

åŸºäº Django çš„è½»é‡çº§ IT èµ„äº§ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒè‡ªåŠ¨åŒ–ç¡¬ä»¶ä¿¡æ¯é‡‡é›†å’Œç®¡ç†ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **è‡ªåŠ¨åŒ–é‡‡é›†**ï¼šAgent è‡ªåŠ¨é‡‡é›†æœåŠ¡å™¨ç¡¬ä»¶ä¿¡æ¯ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- **è¿œç¨‹è„šæœ¬æ‰§è¡Œ**ï¼šAgent è„šæœ¬é›†ä¸­ç®¡ç†ï¼ŒèŠ‚ç‚¹é€šè¿‡ `curl | python3` è¿œç¨‹æ‰§è¡Œ
- **IP ç™½åå•**ï¼šæ”¯æŒ IP/CIDR ç½‘æ®µè®¿é—®æ§åˆ¶
- **å®šæ—¶ä»»åŠ¡ç®¡ç†**ï¼šWeb ç•Œé¢ç»Ÿä¸€é…ç½®å’Œæ‰¹é‡æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹ cron ä»»åŠ¡
- **NVMe/NVMeoF æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒ PCIe NVMe å’Œ RDMA NVMeoF ç£ç›˜è¯†åˆ«
- **è½»é‡çº§éƒ¨ç½²**ï¼šSQLite æ•°æ®åº“ï¼ŒDocker ä¸€é”®éƒ¨ç½²

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è¿œç¨‹è„šæœ¬æ‰§è¡Œæ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         HTTP GET          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CMDB Server    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Managed Node   â”‚
â”‚  (Django)       â”‚                            â”‚                 â”‚
â”‚                 â”‚                            â”‚  Cron Task:     â”‚
â”‚ /api/agent/     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  curl | python3 â”‚
â”‚   script/       â”‚   è¿”å› agent.py å†…å®¹       â”‚                 â”‚
â”‚                 â”‚                            â”‚                 â”‚
â”‚                 â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                 â”‚
â”‚ /api/agent/     â”‚   POST ç¡¬ä»¶ä¿¡æ¯            â”‚                 â”‚
â”‚   report/       â”‚                            â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- âœ… è„šæœ¬é›†ä¸­å­˜å‚¨åœ¨ CMDB æœåŠ¡å™¨
- âœ… æ›´æ–°è„šæœ¬åæ‰€æœ‰èŠ‚ç‚¹è‡ªåŠ¨ä½¿ç”¨æ–°ç‰ˆæœ¬
- âœ… åˆ é™¤èŠ‚ç‚¹åªéœ€æ¸…ç† `/etc/cron.d/cmdb_agent` æ–‡ä»¶
- âœ… èŠ‚ç‚¹æ— éœ€å­˜å‚¨ä»»ä½•è„šæœ¬æ–‡ä»¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **å…‹éš†é¡¹ç›®**

```bash
git clone https://github.com/your-username/cmdb.git
cd cmdb
```

2. **é…ç½®ç¯å¢ƒå˜é‡**

```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œä¿®æ”¹é…ç½®
vim .env
```

3. **å¯åŠ¨æœåŠ¡**

```bash
docker-compose up -d
```

4. **è®¿é—®ç³»ç»Ÿ**

```
http://localhost:8000
é»˜è®¤è´¦å·ï¼šadmin / admin123
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. **å®‰è£…ä¾èµ–**

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2. **åˆå§‹åŒ–æ•°æ®åº“**

```bash
python manage.py migrate
python manage.py createsuperuser
```

3. **å¯åŠ¨æœåŠ¡**

```bash
python manage.py runserver 0.0.0.0:8000
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. ç³»ç»Ÿè®¾ç½®

è®¿é—® **ç³»ç»Ÿè®¾ç½®** é¡µé¢é…ç½®ï¼š

- **IP ç™½åå•**ï¼šå…è®¸è®¿é—® Agent è„šæœ¬ä¸‹è½½ API çš„ IP/ç½‘æ®µ
  ```
  10.10.90.0/24
  172.16.0.0/12
  192.168.1.100
  ```

- **Cron å®šæ—¶ä»»åŠ¡**ï¼šé…ç½®é‡‡é›†é¢‘ç‡
  ```
  0 * * * *      # æ¯å°æ—¶æ‰§è¡Œ
  */30 * * * *   # æ¯ 30 åˆ†é’Ÿæ‰§è¡Œ
  0 */2 * * *    # æ¯ 2 å°æ—¶æ‰§è¡Œ
  ```

### 2. æ·»åŠ æœåŠ¡å™¨

1. ç‚¹å‡» **æ·»åŠ æœåŠ¡å™¨**
2. å¡«å†™æœåŠ¡å™¨ä¿¡æ¯ï¼š
   - ç®¡ç† IP
   - SSH ç”¨æˆ·å/å¯†ç /ç«¯å£
   - ä¸»æœºåï¼ˆå¯é€‰ï¼‰
3. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - æµ‹è¯• SSH è¿æ¥
   - æ£€æŸ¥ Python3 å’Œ curl
   - åˆ›å»ºå®šæ—¶ä»»åŠ¡ `/etc/cron.d/cmdb_agent`
   - ç«‹å³æ‰§è¡Œä¸€æ¬¡é‡‡é›†

### 3. æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯

ç‚¹å‡»æœåŠ¡å™¨è¯¦æƒ…é¡µé¢ï¼ŒæŸ¥çœ‹ï¼š

- **CPU ä¿¡æ¯**ï¼šå‹å·ã€æ¶æ„ã€æ ¸å¿ƒæ•°ã€Socket æ•°
- **å†…å­˜ä¿¡æ¯**ï¼šæ¯æ¡å†…å­˜çš„æ’æ§½ã€å®¹é‡ã€é¢‘ç‡ã€åºåˆ—å·ã€å‚å•†
- **ç£ç›˜ä¿¡æ¯**ï¼šè®¾å¤‡åã€ç±»å‹ï¼ˆNVMe/SSD/HDD/RDMAï¼‰ã€å®¹é‡ã€åºåˆ—å·ã€PCIe æ§½ä½

### 4. æ‰¹é‡æ›´æ–°å®šæ—¶ä»»åŠ¡

ä¿®æ”¹ Cron è¡¨è¾¾å¼åï¼Œç‚¹å‡» **ä¸€é”®æ›´æ–°æ‰€æœ‰ä¸»æœºå®šæ—¶ä»»åŠ¡** æ‰¹é‡æ¨é€é…ç½®ã€‚

## ğŸ”§ Agent è„šæœ¬

### èŠ‚ç‚¹å®šæ—¶ä»»åŠ¡ç¤ºä¾‹

```bash
# /etc/cron.d/cmdb_agent
0 * * * * root curl -s http://cmdb-server:8000/api/agent/script/ | python3 - --server http://cmdb-server:8000 >> /var/log/cmdb_agent.log 2>&1
```

### æ‰‹åŠ¨æ‰§è¡Œ Agent

```bash
curl -s http://cmdb-server:8000/api/agent/script/ | python3 - --server http://cmdb-server:8000
```

### Agent é‡‡é›†ä¿¡æ¯

- **åŸºæœ¬ä¿¡æ¯**ï¼šSNã€ä¸»æœºåã€ç®¡ç† IP
- **CPU**ï¼šlscpu + dmidecode
- **å†…å­˜**ï¼šdmidecode -t memory
- **ç£ç›˜**ï¼š
  - å®¹é‡ï¼šlsblkï¼ˆæ‰¹é‡è·å–ï¼‰
  - ç±»å‹ï¼š/sys/block/*/queue/rotational
  - NVMe åºåˆ—å·ï¼šnvme list -o jsonï¼ˆæ‰¹é‡è·å–ï¼‰
  - PCIe æ§½ä½ï¼šnvme list-subsysï¼ˆæ‰¹é‡è·å–ï¼Œæ”¯æŒ RDMA è¯†åˆ«ï¼‰
  - SATA/SAS åºåˆ—å·ï¼šsmartctl

### ä¼˜åŒ–ç‰¹æ€§

- âœ… æ‰¹é‡å‘½ä»¤è°ƒç”¨ï¼ˆå‡å°‘çº¦ 92% çš„å‘½ä»¤æ‰§è¡Œæ¬¡æ•°ï¼‰
- âœ… æ”¯æŒ NVMeoFï¼ˆRDMAï¼‰ç£ç›˜è¯†åˆ«
- âœ… è‡ªåŠ¨åŒºåˆ†ç‰©ç† PCIe å’Œè¿œç¨‹ RDMA è¿æ¥

## ğŸ“ é¡¹ç›®ç»“æ„

```
cmdb/
â”œâ”€â”€ assets/                 # æ ¸å¿ƒåº”ç”¨
â”‚   â”œâ”€â”€ models.py          # æ•°æ®æ¨¡å‹ï¼ˆServer, HardwareInfo, SystemConfigï¼‰
â”‚   â”œâ”€â”€ views.py           # Web è§†å›¾
â”‚   â”œâ”€â”€ api_views.py       # API æ¥å£ï¼ˆè„šæœ¬ä¸‹è½½ã€æ•°æ®ä¸ŠæŠ¥ï¼‰
â”‚   â”œâ”€â”€ utils.py           # å·¥å…·å‡½æ•°ï¼ˆSSH éƒ¨ç½²ï¼‰
â”‚   â”œâ”€â”€ agent.py           # Agent é‡‡é›†è„šæœ¬
â”‚   â””â”€â”€ migrations/        # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ templates/             # HTML æ¨¡æ¿
â”‚   â”œâ”€â”€ base.html
â”‚   â”œâ”€â”€ server_list.html
â”‚   â”œâ”€â”€ server_detail.html
â”‚   â”œâ”€â”€ add_server.html
â”‚   â””â”€â”€ system_settings.html
â”œâ”€â”€ cmdb/                  # Django é¡¹ç›®é…ç½®
â”‚   â”œâ”€â”€ settings.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ wsgi.py
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šDjango 4.2 + Django REST Framework 3.14
- **æ•°æ®åº“**ï¼šSQLiteï¼ˆå¯æ‰©å±•ä¸º PostgreSQL/MySQLï¼‰
- **SSH**ï¼šParamiko 3.3.1
- **å‰ç«¯**ï¼šBootstrap 5 + Bootstrap Icons
- **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose

## ğŸ“Š æ•°æ®æ¨¡å‹

### Serverï¼ˆæœåŠ¡å™¨ï¼‰

- `sn`ï¼šåºåˆ—å·
- `hostname`ï¼šä¸»æœºå
- `management_ip`ï¼šç®¡ç† IPï¼ˆå”¯ä¸€ï¼‰
- `status`ï¼šçŠ¶æ€ï¼ˆonline/offline/unknownï¼‰
- `ssh_username/password/port`ï¼šSSH è¿æ¥ä¿¡æ¯
- `agent_deployed`ï¼šAgent æ˜¯å¦å·²éƒ¨ç½²
- `agent_version`ï¼šAgent ç‰ˆæœ¬
- `last_report_time`ï¼šæœ€åä¸ŠæŠ¥æ—¶é—´

### HardwareInfoï¼ˆç¡¬ä»¶ä¿¡æ¯ï¼‰

- `cpu_info`ï¼šJSONField - CPU ä¿¡æ¯
- `memory_modules`ï¼šJSONField - å†…å­˜æ¡åˆ—è¡¨
- `memory_total_gb`ï¼šç³»ç»Ÿæ€»å†…å­˜
- `disks`ï¼šJSONField - ç£ç›˜åˆ—è¡¨
- `raw_data`ï¼šJSONField - åŸå§‹æ•°æ®å¤‡ä»½
- `collected_at`ï¼šé‡‡é›†æ—¶é—´

### SystemConfigï¼ˆç³»ç»Ÿé…ç½®ï¼‰

- `allowed_networks`ï¼šIP ç™½åå•ï¼ˆæ”¯æŒ CIDRï¼‰
- `cron_expression`ï¼šCron è¡¨è¾¾å¼
- `cron_description`ï¼šå®šæ—¶ä»»åŠ¡æè¿°
- `updated_at`ï¼šæ›´æ–°æ—¶é—´

## ğŸ” å®‰å…¨ç‰¹æ€§

- âœ… IP ç™½åå•è®¿é—®æ§åˆ¶
- âœ… SSH å¯†ç  Base64 ç¼–ç å­˜å‚¨
- âœ… CSRF ä¿æŠ¤
- âœ… è¾“å…¥éªŒè¯ï¼ˆIP æ ¼å¼ã€ç«¯å£èŒƒå›´ã€é‡å¤æ£€æŸ¥ï¼‰

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»ç»´æŠ¤è€…ã€‚

---

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Starï¼**
